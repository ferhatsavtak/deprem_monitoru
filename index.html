<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TÃ¼rkiye CanlÄ± Deprem MonitÃ¶rÃ¼</title>
    <meta name="description" content="TÃ¼rkiye ve Ã§evresi iÃ§in anlÄ±k ve detaylÄ± deprem takip sistemi.">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569' },
                        soft: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1' },
                        brand: { 500: '#6366f1', 600: '#4f46e5' },
                        quake: { 
                            low: '#10b981',     // < 3.0
                            mid: '#fbbf24',     // 3.0 - 3.9
                            high: '#f97316',    // 4.0 - 4.9
                            severe: '#ef4444',  // 5.0 - 5.9
                            extreme: '#7f1d1d'  // > 6.0
                        }
                    },
                    zIndex: { 'mobile-header': '3000', 'sidebar': '2500', 'modal': '4000', 'map-controls': '1000' }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Map Popup */
        .leaflet-popup-content-wrapper { border-radius: 12px; backdrop-filter: blur(10px); }
        .dark .leaflet-popup-content-wrapper { background: rgba(15, 23, 42, 0.95); color: #e2e8f0; border: 1px solid #334155; }
        .dark .leaflet-popup-tip { background: #334155; }
        .leaflet-popup-content-wrapper { background: rgba(255, 255, 255, 0.95); color: #334155; border: 1px solid #cbd5e1; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .leaflet-popup-tip { background: #cbd5e1; }
        
        
        @keyframes ripple-wave-huge {
            0% { transform: scale(0.1); opacity: 0.6; border-width: 10px; }
            100% { transform: scale(80); opacity: 0; border-width: 0px; }
        }
        .quake-wave-huge { position: relative; pointer-events: none; }
        .quake-wave-huge::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            border: 4px solid currentColor; border-radius: 50%; transform: translate(-50%, -50%);
            box-sizing: border-box; animation: ripple-wave-huge 3s ease-out forwards;
        }

        /* Sidebar Transitions */
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }
        @media (min-width: 768px) { .sidebar-closed { transform: translateX(0); } }
        
        .filter-btn.active, .source-btn.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }

        /* Marker Cluster */
        .custom-cluster-icon { background-clip: padding-box; border-radius: 20px; }
        .marker-cluster-small { background-color: rgba(16, 185, 129, 0.6); } .marker-cluster-small div { background-color: rgba(16, 185, 129, 0.6); }
        .marker-cluster-medium { background-color: rgba(245, 158, 11, 0.6); } .marker-cluster-medium div { background-color: rgba(245, 158, 11, 0.6); }
        .marker-cluster-large { background-color: rgba(239, 68, 68, 0.6); } .marker-cluster-large div { background-color: rgba(239, 68, 68, 0.6); }

        /* Badge Dot */
        .badge-dot { width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; position: absolute; top: 4px; right: 4px; box-shadow: 0 0 4px #ef4444; }
    </style>
</head>
<body class="bg-soft-100 dark:bg-dark-900 text-slate-700 dark:text-slate-200 h-[100dvh] w-screen overflow-hidden flex flex-col md:flex-row transition-colors duration-300">

    <header class="md:hidden fixed top-0 left-0 w-full h-16 bg-white/95 dark:bg-dark-800/95 backdrop-blur-md z-mobile-header border-b border-soft-200 dark:border-gray-700 flex items-center justify-between px-4 shadow-sm">
        <button id="mobile-menu-btn" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-700 text-slate-700 dark:text-slate-200 transition relative">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>
            <span id="mobile-menu-badge" class="hidden absolute top-2 right-1 w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></span>
        </button>
        <div class="flex items-center justify-center flex-1 mx-4">
            <img id="logo-mobile" src="img/logo2.svg" alt="Logo" class="h-10 w-auto object-contain">
        </div>
        <button id="mobile-theme-btn" class="p-2 -mr-2 rounded-lg text-yellow-500 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-700 transition">ğŸŒ</button>
    </header>

    <aside id="sidebar" class="sidebar-transition sidebar-closed fixed md:relative top-0 left-0 h-full w-[85vw] md:w-[400px] bg-soft-50/95 dark:bg-dark-800/95 backdrop-blur-xl z-sidebar flex flex-col border-r border-soft-200 dark:border-gray-700 shadow-2xl md:shadow-none pt-16 md:pt-0">
        <div id="sidebar-overlay" class="md:hidden fixed inset-0 bg-black/50 z-[-1] hidden opacity-0 transition-opacity duration-300"></div>

        <div class="hidden md:flex p-4 border-b border-soft-200 dark:border-gray-700 shrink-0 flex-col gap-4">
            <div class="flex justify-between items-center h-16 relative">
                <div class="flex-1 flex justify-start items-center h-full px-2">
                    <img id="logo-desktop" src="img/logo2.svg" alt="Deprem MonitÃ¶rÃ¼" class="h-14 w-auto object-contain transition-all hover:scale-105">
                </div>
                <div class="flex gap-2">
                    <button id="desktop-theme-btn" class="p-2.5 rounded-xl bg-white border border-soft-200 dark:border-transparent dark:bg-dark-700 hover:bg-gray-50 dark:hover:bg-dark-600 transition text-yellow-500 dark:text-gray-300 shadow-sm text-xl" title="TemayÄ± DeÄŸiÅŸtir">ğŸŒ</button>
                    <button id="stats-btn" class="p-2.5 rounded-xl bg-white border border-soft-200 dark:border-transparent dark:bg-dark-700 hover:bg-gray-50 dark:hover:bg-dark-600 transition text-brand-600 dark:text-brand-500 shadow-sm text-xl" title="Ä°statistikler">ğŸ“Š</button>
                    <button id="sound-btn" class="p-2.5 rounded-xl bg-white border border-soft-200 dark:border-transparent dark:bg-dark-700 hover:bg-gray-50 dark:hover:bg-dark-600 transition text-gray-400 shadow-sm text-xl" title="Sesi AÃ§/Kapat">ğŸ”‡</button>
                    <button id="info-btn" class="p-2.5 rounded-xl bg-white border border-soft-200 dark:border-transparent dark:bg-dark-700 hover:bg-gray-50 dark:hover:bg-dark-600 transition text-gray-500 dark:text-gray-400 shadow-sm text-xl" title="Bilgi">â„¹ï¸</button>
                </div>
            </div>
        </div>

        <div class="p-4 space-y-3 border-b border-soft-200 dark:border-gray-700 bg-white/50 dark:bg-dark-800/50">
            <div class="flex flex-col gap-1.5">
                <label class="text-[10px] uppercase font-bold text-gray-500 dark:text-gray-400 tracking-wider">Veri KaynaÄŸÄ±</label>
                <div class="flex bg-soft-200 dark:bg-dark-900 p-1 rounded-lg border border-soft-300 dark:border-gray-700 relative">
                    <button id="btn-kandilli" class="source-btn active flex-1 py-1.5 text-xs font-bold rounded-md transition text-gray-600 dark:text-gray-300 relative" data-source="kandilli">KANDÄ°LLÄ°<span id="badge-kandilli" class="hidden badge-dot animate-pulse"></span></button>
                    <button id="btn-afad" class="source-btn flex-1 py-1.5 text-xs font-bold rounded-md transition text-gray-600 dark:text-gray-300 relative" data-source="afad">AFAD<span id="badge-afad" class="hidden badge-dot animate-pulse"></span></button>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-white dark:bg-dark-700 p-2 rounded-lg text-center shadow-sm border border-soft-200 dark:border-gray-600 cursor-pointer hover:bg-soft-50 dark:hover:bg-dark-600" onclick="document.getElementById('stats-modal').style.display='flex'">
                    <div class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Adet</div>
                    <div id="stat-count" class="text-lg font-bold text-brand-600 dark:text-brand-500">-</div>
                </div>
                <div class="bg-white dark:bg-dark-700 p-2 rounded-lg text-center shadow-sm border border-soft-200 dark:border-gray-600">
                    <div class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Max</div>
                    <div id="stat-max" class="text-lg font-bold text-quake-severe">-</div>
                </div>
                <div class="bg-white dark:bg-dark-700 p-2 rounded-lg text-center shadow-sm border border-soft-200 dark:border-gray-600">
                    <div class="text-[10px] uppercase tracking-wider text-gray-500 dark:text-gray-400">Son</div>
                    <div id="stat-last" class="text-xs font-bold mt-1 truncate px-1">-</div>
                </div>
            </div>
            <div class="flex gap-1 bg-soft-100 dark:bg-dark-900 p-1 rounded-lg border border-soft-200 dark:border-gray-700">
                <button class="filter-btn active flex-1 py-1.5 text-xs font-medium rounded hover:bg-white dark:hover:bg-dark-700 transition text-gray-600 dark:text-gray-300" data-time="24">24S</button>
                <button class="filter-btn flex-1 py-1.5 text-xs font-medium rounded hover:bg-white dark:hover:bg-dark-700 transition text-gray-600 dark:text-gray-300" data-time="0">TÃœMÃœ</button>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <input type="text" id="search-input" placeholder="Åehir ara..." class="w-full bg-white dark:bg-dark-900 border border-soft-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-brand-500 transition placeholder-gray-400 dark:placeholder-gray-600 text-slate-700 dark:text-slate-200">
                <select id="mag-filter" class="w-full bg-white dark:bg-dark-900 border border-soft-200 dark:border-gray-700 rounded-lg px-2 py-2 text-xs focus:outline-none text-slate-700 dark:text-slate-200 font-medium">
                    <option value="0">TÃ¼m</option><option value="3">> 3.0</option><option value="4">> 4.0</option><option value="5">> 5.0</option>
                </select>
            </div>
        </div>

        <div id="quake-list" class="flex-1 overflow-y-auto p-2 space-y-2 scroll-smooth bg-soft-50 dark:bg-transparent">
            <div class="animate-pulse space-y-3 p-2">
                <div class="h-16 bg-soft-200 dark:bg-dark-700 rounded-lg"></div>
                <div class="h-16 bg-soft-200 dark:bg-dark-700 rounded-lg"></div>
            </div>
        </div>

        <div class="md:hidden p-4 border-t border-soft-200 dark:border-gray-700 bg-soft-100 dark:bg-dark-900 flex justify-around">
            <button class="mobile-footer-btn flex flex-col items-center text-xs text-gray-500 dark:text-gray-400" onclick="document.getElementById('stats-btn').click()"><span class="text-lg">ğŸ“Š</span> Ä°statistik</button>
            <button class="mobile-footer-btn flex flex-col items-center text-xs text-gray-500 dark:text-gray-400" onclick="document.getElementById('sound-btn').click()"><span class="text-lg" id="mobile-sound-icon">ğŸ”‡</span> Ses</button>
            <button class="mobile-footer-btn flex flex-col items-center text-xs text-gray-500 dark:text-gray-400" onclick="document.getElementById('info-btn').click()"><span class="text-lg">â„¹ï¸</span> Bilgi</button>
        </div>
    </aside>

    <main class="flex-1 relative z-0 bg-soft-100 dark:bg-dark-900 pt-16 md:pt-0 h-full" id="map-container">
        <div id="map" class="w-full h-full outline-none"></div>
        
        <div class="absolute top-20 right-2 md:top-4 md:right-4 z-map-controls flex flex-col gap-2">
            <button id="locate-btn" class="bg-white/90 dark:bg-dark-800/90 text-slate-700 dark:text-white p-3 rounded-lg shadow-lg hover:bg-soft-100 dark:hover:bg-dark-700 backdrop-blur border border-soft-200 dark:border-gray-700 transition" title="Konumum"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" /></svg></button>
            <button id="reset-view-btn" class="bg-white/90 dark:bg-dark-800/90 text-slate-700 dark:text-white p-3 rounded-lg shadow-lg hover:bg-soft-100 dark:hover:bg-dark-700 backdrop-blur border border-soft-200 dark:border-gray-700 transition" title="TÃ¼rkiye Odak"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498l4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 00-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0z" /></svg></button>
            <button id="cluster-toggle-btn" class="bg-slate-500 text-white p-3 rounded-lg shadow-lg hover:bg-slate-600 backdrop-blur border border-slate-400 dark:border-gray-600 transition" title="KÃ¼meleme"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.875 0h15.75c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H4.125C3.504 4.5 3 5.004 3 5.625v12.75c0 .621.504 1.125 1.125 1.125z" /></svg></button>
            <button id="fullscreen-btn" class="hidden md:block bg-white/90 dark:bg-dark-800/90 text-slate-700 dark:text-white p-3 rounded-lg shadow-lg hover:bg-soft-100 dark:hover:bg-dark-700 backdrop-blur border border-soft-200 dark:border-gray-700 transition" title="Tam Ekran"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg></button>
        </div>
        
        <div class="absolute bottom-20 right-2 md:bottom-8 md:right-4 z-map-controls bg-white/90 dark:bg-dark-800/90 p-3 rounded-lg backdrop-blur border border-soft-200 dark:border-gray-700 shadow-xl text-xs select-none text-slate-700 dark:text-gray-300 pointer-events-none scale-90 md:scale-100 origin-bottom-right">
            <div class="space-y-1">
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-quake-low"></span> < 3.0 (Hafif)</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-quake-mid"></span> 3.0 - 3.9 (Orta)</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-quake-high"></span> 4.0 - 4.9 (YÃ¼ksek)</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-quake-severe"></span> 5.0 - 5.9 (Åiddetli)</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-quake-extreme"></span> > 6.0 (YÄ±kÄ±cÄ±)</div>
            </div>
        </div>
        
        <div id="live-alert" class="absolute top-24 left-4 md:top-4 md:left-[440px] right-4 md:right-auto z-[3500] hidden transform transition-all duration-500 translate-y-[-150px]">
            <div class="bg-red-600/95 backdrop-blur text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-4 border border-red-400 max-w-md w-full">
                <div class="animate-bounce text-2xl">ğŸš¨</div>
                <div><div class="font-bold text-lg">YENÄ° DEPREM</div><div id="alert-text" class="text-sm opacity-90">-</div></div>
            </div>
        </div>
    </main>

    <div id="stats-modal" class="fixed inset-0 z-modal bg-black/60 hidden items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-dark-800 border border-soft-200 dark:border-gray-700 rounded-2xl max-w-2xl w-full p-6 shadow-2xl relative">
            <button class="close-modal absolute top-4 right-4 text-slate-500 dark:text-gray-400 hover:text-black dark:hover:text-white text-xl">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-brand-600 dark:text-brand-500">ğŸ“Š Deprem Ä°statistikleri</h2>
            <div class="w-full h-64 md:h-80">
                <canvas id="statsChart"></canvas>
            </div>
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 z-modal bg-black/60 hidden items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-dark-800 border border-soft-200 dark:border-gray-700 rounded-2xl max-w-md w-full p-6 shadow-2xl relative">
            <button class="close-modal absolute top-4 right-4 text-slate-500 dark:text-gray-400 hover:text-black dark:hover:text-white text-xl">&times;</button>
            <h2 class="text-xl font-bold mb-4 text-brand-600 dark:text-brand-500">HakkÄ±nda & GÃ¼venlik</h2>
            <div class="space-y-4 text-sm text-slate-700 dark:text-gray-300">
                <p>Bu uygulama <strong>Ferhat Savtak</strong> tarafÄ±ndan oluÅŸturulmuÅŸtur. Uygulama <strong>Orhan AydoÄŸdu API</strong> aracÄ±lÄ±ÄŸÄ±yla Kandilli ve AFAD verilerini anlÄ±k olarak derler.</p>
                <div class="bg-green-50 dark:bg-dark-700 p-3 rounded-lg border-l-4 border-green-500">
                    <h3 class="font-bold text-gray-900 dark:text-white mb-1">Deprem AnÄ±nda:</h3>
                    <ul class="list-disc list-inside">
                        <li>Ã‡Ã¶k - Kapan - Tutun</li>
                        <li>Pencerelerden uzak dur</li>
                        <li>Merdivenleri kullanma</li>
                    </ul>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <a href="tel:112" class="bg-red-600 hover:bg-red-700 text-white py-2 rounded text-center font-bold block transition">ğŸš‘ 112 Acil</a>
                    <a href="tel:122" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded text-center font-bold block transition">ğŸ›¡ï¸ 122 AFAD</a>
                </div>

                <a href="https://github.com/ferhatsavtak" target="_blank" class="bg-gray-800 hover:bg-gray-900 dark:bg-gray-700 dark:hover:bg-gray-600 text-white py-2.5 rounded-lg text-center font-bold block transition mt-3 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5" viewBox="0 0 16 16">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    GitHub Profiline Git
                </a>

            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const API_ENDPOINTS = { 'kandilli': 'https://api.orhanaydogdu.com.tr/deprem/kandilli/live?limit=500', 'afad': 'https://api.orhanaydogdu.com.tr/deprem/afad/live?limit=500' };
    let map, markers, singleLayer, baseTileLayer, activeData = [], cachedData = { kandilli: null, afad: null }, lastKnownIds = { kandilli: null, afad: null };
    let isMuted = true, isSidebarOpen = false, useCluster = false, currentSource = 'kandilli', currentTimeFilter = 24, statsChart = null, audioAlert = null, audioContext = null;
    let newlyArrivedQuakeIds = new Set();

    function createBeepSound() {
        try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); return { play: function() { const oscillator = audioContext.createOscillator(); const gainNode = audioContext.createGain(); oscillator.connect(gainNode); gainNode.connect(audioContext.destination); oscillator.frequency.value = 880; oscillator.type = 'sine'; gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3); oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + 0.3); return Promise.resolve(); } }; } catch(e) { return { play: () => Promise.resolve() }; }
    }
    audioAlert = createBeepSound();

    document.addEventListener('DOMContentLoaded', () => {
        initMap(); fetchSource('kandilli'); fetchSource('afad');
        setInterval(() => { fetchSource('kandilli'); fetchSource('afad'); }, 30000);
        setupEventListeners(); updateLogo();
    });

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([39.0, 35.0], 6);
        baseTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(map);
        L.control.zoom({ position: 'bottomleft' }).addTo(map); 
        markers = L.markerClusterGroup({ maxClusterRadius: 40, iconCreateFunction: function(cluster) { const count = cluster.getChildCount(); let c = 'marker-cluster-'; if (count < 10) c += 'small'; else if (count < 50) c += 'medium'; else c += 'large'; return new L.DivIcon({ html: `<div class="flex items-center justify-center w-full h-full text-white font-bold rounded-full border-2 ${c}">${count}</div>`, className: 'custom-cluster-icon w-10 h-10', iconSize: new L.Point(40, 40) }); } });
        singleLayer = L.layerGroup(); map.addLayer(singleLayer);
    }
    
    function updateLogo() {
        const isDark = document.documentElement.classList.contains('dark'); const desktopLogo = document.getElementById('logo-desktop'); const mobileLogo = document.getElementById('logo-mobile');
        const logoSrc = isDark ? 'img/logo2.svg' : 'img/logo1.svg'; if(desktopLogo) desktopLogo.src = logoSrc; if(mobileLogo) mobileLogo.src = logoSrc;
    }

    function toggleTheme() {
        const html = document.documentElement; const isDark = html.classList.toggle('dark');
        document.querySelectorAll('#desktop-theme-btn, #mobile-theme-btn').forEach(btn => btn.innerText = isDark ? 'ğŸŒ' : 'ğŸŒš');
        baseTileLayer.setUrl(`https://{s}.basemaps.cartocdn.com/${isDark ? 'dark' : 'light'}_all/{z}/{x}/{y}{r}.png`);
        if(statsChart) { statsChart.destroy(); statsChart = null; } updateLogo();
    }

    async function fetchSource(source) {
        try {
            const res = await fetch(API_ENDPOINTS[source]); const json = await res.json();
            if (json.status && json.result) {
                const resultData = json.result; cachedData[source] = resultData; 
                if (resultData.length > 0) {
                    const latestQuake = resultData[0]; const latestId = latestQuake.earthquake_id;
                    if (lastKnownIds[source] !== null && lastKnownIds[source] !== latestId) { handleNewQuake(source, latestQuake); }
                    lastKnownIds[source] = latestId;
                }
                if (currentSource === source) { activeData = resultData; updateUI(); }
            }
        } catch (e) { console.error(`Error fetching ${source}:`, e); }
    }

    function handleNewQuake(source, quake) {
        newlyArrivedQuakeIds.add(quake.earthquake_id);
        setTimeout(() => { newlyArrivedQuakeIds.delete(quake.earthquake_id); updateUI(); }, 300000);

        if (currentSource !== source) {
            toggleBadge(source, true);
        } else {
            focusAndWaveOnNewQuake(quake); 
            triggerAlert(quake);
            if (!isMuted) { audioAlert.play().catch(console.error); }
        }
    }

    function toggleBadge(source, show) {
        const badge = document.getElementById(`badge-${source}`); const mobileBadge = document.getElementById('mobile-menu-badge');
        if (show) { if(badge) badge.classList.remove('hidden'); if(mobileBadge) mobileBadge.classList.remove('hidden'); } 
        else { if(badge) badge.classList.add('hidden'); if(mobileBadge) mobileBadge.classList.add('hidden'); }
    }

    function updateUI() {
        const filterMag = parseFloat(document.getElementById('mag-filter').value); const filterText = document.getElementById('search-input').value.toLowerCase();
        let filtered = activeData.filter(q => {
            const matchesMag = parseFloat(q.mag) >= filterMag; const matchesLoc = q.title.toLowerCase().includes(filterText);
            let matchesTime = true; if (currentTimeFilter > 0) { matchesTime = new Date(q.date_time).getTime() >= Date.now() - (currentTimeFilter * 3600000); }
            return matchesMag && matchesLoc && matchesTime;
        });
        renderList(filtered); renderMapMarkers(filtered); updateStats(filtered);
    }

    function getQuakeColor(mag) { if(mag < 3.0) return '#10b981'; if(mag < 4.0) return '#fbbf24'; if(mag < 5.0) return '#f97316'; if(mag < 6.0) return '#ef4444'; return '#7f1d1d'; }

    function renderList(data) {
        const listEl = document.getElementById('quake-list'); listEl.innerHTML = '';
        if (data.length === 0) { listEl.innerHTML = '<div class="text-center text-slate-500 dark:text-gray-500 mt-10">Kriterlere uygun deprem bulunamadÄ±.</div>'; return; }
        data.forEach(q => {
            const mag = parseFloat(q.mag); const dateObj = new Date(q.date_time); const colorCode = getQuakeColor(mag);
            const isNew = newlyArrivedQuakeIds.has(q.earthquake_id);
            const item = document.createElement('div');
            item.className = `bg-white dark:bg-dark-700 hover:bg-soft-100 dark:hover:bg-dark-600 p-3 rounded-r-lg shadow-sm border-l-4 border-soft-200 dark:border-transparent cursor-pointer transition group animate-fade-in relative`;
            item.style.borderLeftColor = colorCode; item.onclick = () => focusOnQuake(q);
            item.innerHTML = `<div class="flex justify-between items-start"><div><div class="font-bold text-sm text-slate-700 dark:text-gray-200 group-hover:text-brand-600 dark:group-hover:text-brand-500 transition flex items-center gap-2">${q.title}${isNew ? '<span class="px-1.5 py-0.5 rounded text-[10px] bg-red-600 text-white animate-pulse">YENÄ°</span>' : ''}</div><div class="text-xs text-slate-500 dark:text-gray-400 mt-1"><span class="font-mono">${dateObj.toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })}</span> <span class="opacity-60">(${timeSince(dateObj)})</span></div><div class="text-xs text-slate-400 dark:text-gray-500 mt-0.5">ğŸ“‰ ${parseFloat(q.depth).toFixed(1)}km</div></div><div class="flex flex-col items-end"><span class="text-xl font-bold" style="color: ${colorCode}">${mag.toFixed(1)}</span></div></div>`;
            listEl.appendChild(item);
        });
    }

    function renderMapMarkers(data) {
        markers.clearLayers(); singleLayer.clearLayers(); const layersToAdd = [];
        data.forEach(q => {
            const lat = q.geojson.coordinates[1]; const lng = q.geojson.coordinates[0]; const mag = parseFloat(q.mag); const color = getQuakeColor(mag);
            let radius = mag >= 5 ? 14 : mag >= 4 ? 10 : mag >= 3 ? 8 : 6;
            const circle = L.circleMarker([lat, lng], { radius: radius, fillColor: color, color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8 });
            circle.bindPopup(createPopupContent(q, color)); layersToAdd.push(circle);
        });
        if(useCluster) markers.addLayers(layersToAdd); else layersToAdd.forEach(l => singleLayer.addLayer(l));
    }
    
    function createPopupContent(q, color) {
        const dateObj = new Date(q.date_time); const mag = parseFloat(q.mag); if (!color) color = getQuakeColor(mag);
        return `<div class="p-2 min-w-[160px]"><h3 class="font-bold text-brand-600 dark:text-brand-500 mb-1">${q.title}</h3><div class="flex justify-between items-center mb-2"><span class="px-2 py-0.5 rounded text-sm font-bold text-white" style="background-color: ${color}">${mag.toFixed(1)}</span><span class="text-xs text-slate-500 dark:text-gray-300">${timeSince(dateObj)}</span></div><div class="text-xs text-slate-500 dark:text-gray-400 border-t border-soft-200 dark:border-gray-600 pt-2 mt-1"><div>ğŸ“… ${dateObj.toLocaleString('tr-TR')}</div><div>ğŸ“‰ Derinlik: ${q.depth} km</div><div class="mt-1 italic text-[10px] opacity-70">Kaynak: ${currentSource.toUpperCase()}</div></div></div>`;
    }

    function updateStats(data) {
        if(!data.length) { document.getElementById('stat-count').innerText = "0"; return; }
        document.getElementById('stat-count').innerText = data.length;
        document.getElementById('stat-max').innerText = Math.max(...data.map(q => parseFloat(q.mag))).toFixed(1);
        const last = data[0]; document.getElementById('stat-last').innerText = `${last.title.split(' ')[0]} (${new Date(last.date_time).toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})})`;
    }

    function initChart(data) {
        const ctx = document.getElementById('statsChart').getContext('2d');
        const counts = { '0-3': 0, '3-4': 0, '4-5': 0, '5-6': 0, '6+': 0 };
        data.forEach(q => { const m = parseFloat(q.mag); if (m < 3) counts['0-3']++; else if (m < 4) counts['3-4']++; else if (m < 5) counts['4-5']++; else if (m < 6) counts['5-6']++; else counts['6+']++; });
        const isDark = document.documentElement.classList.contains('dark');
        const chartData = { labels: ['< 3.0', '3-4', '4-5', '5-6', '> 6.0'], datasets: [{ data: Object.values(counts), backgroundColor: ['#10b981', '#fbbf24', '#f97316', '#ef4444', '#7f1d1d'], borderWidth: 0, borderRadius: 4 }] };
        if (statsChart) { statsChart.data = chartData; statsChart.update(); } 
        else { Chart.defaults.color = isDark ? '#94a3b8' : '#475569'; Chart.defaults.borderColor = isDark ? '#334155' : '#e2e8f0'; statsChart = new Chart(ctx, { type: 'bar', data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } }); }
    }

    function focusAndWaveOnNewQuake(quake) {
        const lat = parseFloat(quake.geojson.coordinates[1]); const lng = parseFloat(quake.geojson.coordinates[0]);
        map.flyTo([lat, lng], 10, { duration: 1.5 });
        const waveIcon = L.divIcon({ className: 'quake-wave-huge', html: `<div style="color: #ef4444; width: 100%; height: 100%;"></div>`, iconSize: [20, 20], iconAnchor: [10, 10] });
        const waveMarker = L.marker([lat, lng], { icon: waveIcon }).addTo(map);
        setTimeout(() => map.removeLayer(waveMarker), 10000);
    }

    function focusOnQuake(q) {
        const lat = parseFloat(q.geojson.coordinates[1]); const lng = parseFloat(q.geojson.coordinates[0]); const color = getQuakeColor(parseFloat(q.mag));
        if(window.innerWidth < 768) toggleSidebar(false);
        map.flyTo([lat, lng], 10, { duration: 1.5 });
        setTimeout(() => { L.popup({ offset: L.point(0, -5) }).setLatLng([lat, lng]).setContent(createPopupContent(q, color)).openOn(map); }, 1000);
        const waveIcon = L.divIcon({ className: 'quake-wave-huge', html: `<div style="color: ${color}; width: 100%; height: 100%;"></div>`, iconSize: [20, 20], iconAnchor: [10, 10] });
        const waveMarker = L.marker([lat, lng], { icon: waveIcon }).addTo(map);
        setTimeout(() => map.removeLayer(waveMarker), 10000); 
    }

    function triggerAlert(quake) {
        if(parseFloat(quake.mag) < 3.5) return;
        const alertBanner = document.getElementById('live-alert'); document.getElementById('alert-text').innerText = `${quake.title} - ${quake.mag}`;
        alertBanner.classList.remove('hidden'); requestAnimationFrame(() => alertBanner.style.transform = 'translateY(0)');
        setTimeout(() => { alertBanner.style.transform = 'translateY(-150px)'; setTimeout(() => alertBanner.classList.add('hidden'), 500); }, 8000);
    }

    function timeSince(date) { const seconds = Math.floor((new Date() - date) / 1000); let interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "s Ã¶nce"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "dk Ã¶nce"; return "Åimdi"; }
    function toggleSidebar(state = null) { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('sidebar-overlay'); if (state === null) isSidebarOpen = !isSidebarOpen; else isSidebarOpen = state; if (isSidebarOpen) { sidebar.classList.remove('sidebar-closed'); sidebar.classList.add('sidebar-open'); overlay.classList.remove('hidden'); setTimeout(() => overlay.classList.remove('opacity-0'), 10); } else { sidebar.classList.add('sidebar-closed'); sidebar.classList.remove('sidebar-open'); overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 300); } }

    function setupEventListeners() {
        document.getElementById('mag-filter').addEventListener('change', updateUI); document.getElementById('search-input').addEventListener('input', updateUI);
        document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', (e) => { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); currentTimeFilter = parseInt(e.target.dataset.time); updateUI(); }));
        document.querySelectorAll('.source-btn').forEach(btn => btn.addEventListener('click', (e) => { const target = e.currentTarget; const source = target.dataset.source; document.querySelectorAll('.source-btn').forEach(b => b.classList.remove('active')); target.classList.add('active'); toggleBadge(source, false); currentSource = source; if (cachedData[source]) { activeData = cachedData[source]; updateUI(); } else { document.getElementById('quake-list').innerHTML = '<div class="text-center p-4 mt-10"><div class="animate-spin h-8 w-8 border-4 border-brand-500 rounded-full border-t-transparent mx-auto"></div><div class="mt-2 text-xs opacity-50">Veriler AlÄ±nÄ±yor...</div></div>'; fetchSource(source); } }));
        document.getElementById('cluster-toggle-btn').addEventListener('click', (e) => { 
            useCluster = !useCluster; 
            const btn = e.currentTarget;
            btn.classList.toggle('bg-brand-600', useCluster);
            btn.classList.toggle('bg-slate-500', !useCluster);
            if (useCluster) { map.removeLayer(singleLayer); map.addLayer(markers); } 
            else { map.removeLayer(markers); map.addLayer(singleLayer); }
            renderMapMarkers(activeData);
        });
        document.getElementById('fullscreen-btn').addEventListener('click', () => { if (!document.fullscreenElement) document.getElementById('map-container').requestFullscreen(); else document.exitFullscreen(); });
        document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.fixed').style.display = 'none'));
        document.getElementById('desktop-theme-btn').addEventListener('click', toggleTheme); document.getElementById('mobile-theme-btn').addEventListener('click', toggleTheme);
        const sBtn = document.getElementById('sound-btn'); const mSoundIcon = document.getElementById('mobile-sound-icon');
        sBtn.addEventListener('click', () => { isMuted = !isMuted; if (!isMuted) { sBtn.innerText = 'ğŸ”Š'; if(mSoundIcon) mSoundIcon.innerText = 'ğŸ”Š'; if (audioContext && audioContext.state === 'suspended') { audioContext.resume(); } audioAlert.play().catch(console.error); } else { sBtn.innerText = 'ğŸ”‡'; if(mSoundIcon) mSoundIcon.innerText = 'ğŸ”‡'; } });
        document.getElementById('mobile-menu-btn').addEventListener('click', () => toggleSidebar()); document.getElementById('sidebar-overlay').addEventListener('click', () => toggleSidebar(false));
        document.getElementById('reset-view-btn').addEventListener('click', () => map.flyTo([39.0, 35.0], 6));
        document.getElementById('locate-btn').addEventListener('click', () => { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { map.flyTo([pos.coords.latitude, pos.coords.longitude], 12); L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(map).bindPopup("Konumunuz").openPopup(); }); } });
        document.getElementById('stats-btn').addEventListener('click', () => { document.getElementById('stats-modal').style.display = 'flex'; initChart(activeData); });
        document.getElementById('info-btn').addEventListener('click', () => { document.getElementById('info-modal').style.display = 'flex'; });
    }
</script>
</body>
</html>
